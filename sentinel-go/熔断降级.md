# 目录
* [Overview](https://github.com/alibaba/sentinel-golang/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#overview)
* [熔断器的状态机](https://github.com/alibaba/sentinel-golang/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#%E7%86%94%E6%96%AD%E5%99%A8%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA)
* [熔断器的设计](https://github.com/alibaba/sentinel-golang/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#%E7%86%94%E6%96%AD%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1)
* [熔断策略](https://github.com/alibaba/sentinel-golang/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5)
* [熔断器规则的字段含义](https://github.com/alibaba/sentinel-golang/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#%E7%86%94%E6%96%AD%E5%99%A8%E8%A7%84%E5%88%99%E7%9A%84%E5%AD%97%E6%AE%B5%E5%90%AB%E4%B9%89)
* [最佳场景实践](https://github.com/alibaba/sentinel-golang/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%9C%BA%E6%99%AF)
* [熔断器规则使用实例](https://github.com/alibaba/sentinel-golang/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#%E7%86%94%E6%96%AD%E5%99%A8%E8%A7%84%E5%88%99%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B)
* [Example](https://github.com/alibaba/sentinel-golang/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7#example)

# Overview

对调用链路中不稳定的资源进行熔断降级是保障高可用的重要措施之一。由于分布式系统中调用关系的复杂性，如果调用链路中的某个服务不稳定，则依赖该服务的调用方自身可能会被慢调用卡住，最终会导致整个链路请求堆积。

<img src="https://user-images.githubusercontent.com/9434884/62410811-cd871680-b61d-11e9-9df7-3ee41c618644.png" alt="dependnecy-map" width="75%"/>

Sentinel 熔断降级会在调用链路中某个资源出现不稳定状态时（例如慢调用或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断。

# 熔断器的状态机
Sentinel 熔断降级基于熔断器模式实现，熔断器的检查是基于熔断机的状态机的，状态机的转换关系如下图所示：

<img src="https://user-images.githubusercontent.com/9434884/82635455-ca075f00-9c32-11ea-9e99-d67518923e0d.png" alt="circuit-breaker" width="50%"/>

熔断器有三种状态：

1. Closed状态：该状态下，熔断器的会保持闭合，对该资源的访问都可以通过熔断器的检查。
2. Open状态：该状态下，熔断器会断开，对该资源的访问全部都会被切断。
3. Half-Open状态：半开状态，该状态下，对该资源的访问也会被切断。但是经过一定的timeout周期后，Sentinel会运行一个(或则多个)请求通过，对资源进行探测，如果资源恢复到规则设定的状态允许条件以内，代表探测成功，会将熔断器状态切换到Closed；如果探测失败，会返回Open状态。

这三种状态之间的转换关系也比较容易理解：

1. 正常情况下，熔断器处于Closed状态。如果基于统计的数据表明当前资源触发了设定的极限值，那么会将熔断器切换到Open状态；
2. Open状态下会周期性的进行探测，资源是否恢复正常状态。如果探测发现资源恢复到正常状态，那么切换熔断器到Closed状态；如果资源未恢复到正常状态，就会切换回Open状态。
3. 处于Open状态的熔断器会周期性去做探测。

# 熔断器的设计
用户设置的每一个熔断规则都会转换成对用的熔断器，熔断器对用户是不可见的。Sentinel的每个熔断器都会有自己独立的统计结构，根据熔断策略：`SlowRequestRatio`、`ErrorRatio`、`ErrorCount`，熔断器会创建自己独立的统计结构。

熔断器的整体检查逻辑可以用几个点精简的来概括：
1. 基于熔断器的状态机来判断对资源是否可以访问；
2. 对不可访问的资源会有探测机制，探测机制保障了对资源访问的安全性；
3. 熔断器在对资源访问的完成态去更新统计，基于访问资源完成态然后基于规则更新熔断器状态机。

# 熔断策略
sentinel的熔断器支持静默期。静默期是指一个最小的静默请求数，在一个统计周期内，如果当前熔断器处于Closed状态，并且对该资源的访问请求数小于设置的静默数，那么熔断器将不会基于其统计值去更改熔断器的状态。设计静默期的理由也很简单，举个例子，假设在一个统计周期刚刚开始时候，第1个请求碰巧是个慢请求，这个时候这个时候的慢调用比例就会是100%，很明显是不合理，所以存在一定的巧合性。所以静默期的提高了熔断器的精准性以及降低误判可能性。静默期是所有熔断策略都支持的特性。

Sentinel 支持以下几种熔断策略：

* 慢调用比例策略 (SlowRequestRatio)：sentinel的熔断器不在静默期，并且慢调用的比例大于设置的阈值，则接下来的熔断周期内对资源的访问会自动地被熔断。该策略下需要设置对该资源访问的最大响应时间(max resposne time)对该资源访问的响应时间大于该阈值则统计为慢调用。
* 错误比例策略 (ErrorRatio)：sentinel的熔断器不在静默期，在统计周期内资源请求访问异常的比例大于设定的阈值，则接下来的熔断周期内对资源的访问会自动地被熔断。
* 错误计数策略 (ErrorCount)：sentinel的熔断器不在静默期，在统计周期内资源请求访问异常数大于设定的阈值，则接下来的熔断周期内对资源的访问会自动地被熔断。

注意：这里的错误熔断仅针对业务异常，对 Sentinel 限流降级组件内部的异常（`BlockError`）不生效。对于自定义埋点，为了统计异常比例或异常数，需要通过 `api.TraceError(entry, err)` 记录业务异常。

# 熔断器规则的字段含义：
规则的定义如下：
```go
type RuleBase struct {
	Id string
	Resource string
	Strategy Strategy
	RetryTimeoutMs uint32
	MinRequestAmount uint64
	StatIntervalMs uint32
}
type slowRtRule struct {
	RuleBase
	MaxAllowedRtMs uint64
	MaxSlowRequestRatio float64
}
type errorRatioRule struct {
	RuleBase
	Threshold float64
}
type errorCountRule struct {
	RuleBase
	Threshold uint64
}
```

- `Resource`: 熔断器规则针对的埋点资源的名称；
- `Strategy`: 熔断策略，目前支持`SlowRequestRatio`、`ErrorRatio`、`ErrorCount`三种；
  - 选择以**慢调用比例** (SlowRequestRatio) 作为阈值，需要设置允许的**最大响应时间**（MaxAllowedRt），请求的响应时间大于该值则统计为慢调用。通过 `MaxSlowRequestRatio` 字段设置触发熔断的慢调用比例，取值范围为 [0.0, 1.0]。规则配置后，在单位统计时长内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态，若接下来的一个请求响应时间小于设置的最大 RT 则结束熔断，若大于设置的最大 RT 则会再次被熔断。
  - 选择以**错误比例** (ErrorRatio) 作为阈值，需要设置触发熔断的异常比例（`Threshold`），取值范围为 [0.0, 1.0]。规则配置后，在单位统计时长内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态，若接下来的一个请求没有错误则结束熔断，否则会再次被熔断。代码中可以通过 `api.TraceError(entry, err)` 函数来记录 error。
- `RetryTimeoutMs`: 即熔断触发后持续的时间（单位为 ms）。资源进入熔断状态后，在配置的熔断时长内，请求都会快速失败。熔断结束后进入探测恢复模式（HALF-OPEN）。
- `MinRequestAmount`: 静默数量，如果当前统计周期内对资源的访问数量小于静默数量，那么熔断器就处于静默期。换言之，也就是触发熔断的最小请求数目，若当前统计周期内的请求数小于此值，即使达到熔断条件规则也不会触发。
- `StatIntervalMs`: 统计的时间窗口长度（单位为 ms）。
- `slowRtRule.MaxAllowedRtMs`: `仅用于慢调用熔断策略`，MaxAllowedRtMs是判断请求是否是慢调用的临界值，也就是如果请求的response time小于或等于MaxAllowedRtMs，那么就不是慢调用；如果response time大于MaxAllowedRtMs，那么当前请求就属于慢调用。
- `slowRtRule.MaxSlowRequestRatio`: `仅用于慢调用熔断策略`, MaxSlowRequestRatio是当前熔断器判断是否会切换到断开的临界值，也就是如果当前资源的慢调用比例如果高于MaxSlowRequestRatio，那么熔断器就会断开；否则保持闭合状态；
- `errorRatioRule.Threshold`: `仅用于错误比例策略`，Threshold是当前熔断器判断是否会切换到断开的临界值。
- `errorCountRule.Threshold`: `仅用于错误数策略`，Threshold是当前熔断器判断是否会切换到断开的临界值。

# 最佳实践场景：
熔断器一般用于应用对外部资源访问时的保护措施。这里简单描述一些场景：

1. 分布式系统中降级：假设存在应用A需要调用应用B的接口(特别是一些对接外部公司或者业务的接口时候)，那么一般用于A调用B的接口时的防护；
2. 数据库慢调用的防护： 假设应用需要读/写数据库，但是该读写SQL存在潜在慢SQL的可能性，那么可以对该读写接口做防护，当接口不稳定时候(存在慢SQL)，那么基于熔断器做降级。
3. 也可以是应用中任意接口做降级防护。

# 熔断器规则使用实例
这里重点介绍一些如果创建熔断器规则：
[circuitbreaker包](https://github.com/alibaba/sentinel-golang/tree/master/core/circuitbreaker) 提供了熔断器的实现。`circuitbreaker.NewRule(resource string, strategy Strategy, opts ...RuleOption) Rule` 接口用于创建一个熔断器规则实例。

这里 `resource` 和 `strategy` 是必填字段。同时，基于不同的熔断器规则策略，有一些可选参数：
* `func WithRetryTimeoutMs(retryTimeoutMs uint32) RuleOption`: 用于设置熔断器的字段`RetryTimeoutMs`，也就是探测周期。该字段对所有熔断器规则都生效。
* `func WithMinRequestAmount(minRequestAmount uint64) RuleOption`: 用于设置熔断器的字段`MinRequestAmount`，也就是静默期的静默数。该字段对所有熔断器规则都生效。
* `func WithStatIntervalMs(statIntervalMs uint32) RuleOption`: 用于设置熔断器的字段`StatIntervalMs`，也就是统计结构的统计周期。该字段对所有熔断器规则都生效。
* `func WithMaxAllowedRtMs(maxAllowedRtMs uint64) RuleOption`: 用于设置慢调用规则的字段`MaxAllowedRtMs`。该字段仅对慢调用规则生效。
* `func WithMaxSlowRequestRatio(maxSlowRequestRatio float64) RuleOption`: 用于设置慢调用规则的字段`MaxSlowRequestRatio`。该字段仅对慢调用规则生效。
* `func WithErrorRatioThreshold(errorRatioThreshold float64) RuleOption`: 用于设置错误比例规则的字段`Threshold`。该字段仅对错误比例规则生效。
* `func WithErrorCountThreshold(errorCountThreshold uint64) RuleOption`: 用于设置错误数规则的字段`Threshold`。该字段仅对错误数规则生效。

下面给出三种规则的创建实例：
```go
slowRtRule := NewRule("abc", SlowRequestRatio, WithStatIntervalMs(1000),
                        WithRetryTimeoutMs(1000), WithMinRequestAmount(5), 
                        WithMaxAllowedRtMs(20),WithMaxSlowRequestRatio(0.1))

errorRatioRule := NewRule("abc", ErrorRatio, WithStatIntervalMs(1000),
			WithRetryTimeoutMs(1000), WithMinRequestAmount(5),
			WithMaxSlowRequestRatio(0.3))

errorCountRule := NewRule("abc", ErrorCount, WithStatIntervalMs(1000),
			WithRetryTimeoutMs(1000), WithMinRequestAmount(5),
			WithMaxSlowRequestRatio(10))
```


# Example
熔断降级 demo 可以参考 [circuit_breaker_example.go](https://github.com/alibaba/sentinel-golang/blob/master/example/circuitbreaker/circuit_breaker_example.go)
